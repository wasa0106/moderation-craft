# ModerationCraft 要件定義書（逆生成）

## 分析概要

**分析日時**: 2025-08-02
**対象コードベース**: /Users/junya/Dev/moderation-craft
**抽出要件数**: 45個の機能要件、15個の非機能要件
**信頼度**: 85% （実装カバレッジとテストから推定）

## システム概要

### 推定されたシステム目的
個人創作者が創作活動を計画的に進め、作業時間を管理し、心身の健康状態を記録しながらモチベーションを維持するための統合型プロジェクト管理システム。オフライン環境でも継続的に使用でき、作業データを自動同期することで、創作活動に集中できる環境を提供する。

### 対象ユーザー
- **主要ユーザー**: 個人創作者（イラストレーター、作家、デザイナー、プログラマー等）
- **特徴**: 
  - 長時間の集中作業を行う
  - プロジェクトベースで活動
  - 自己管理が必要
  - メンタルヘルスケアに関心がある

## ユーザーストーリー

### ストーリー1: プロジェクト管理
- **である** 個人創作者 **として**
- **私は** 複数のプロジェクトを階層的に管理 **をしたい**
- **そうすることで** 全体の進捗を把握し、計画的に創作活動を進められる

**実装根拠**: 
- プロジェクトCRUD機能（`use-projects.ts`）
- WBSベースのタスク階層（大タスク・小タスク）
- プロジェクトカラー設定機能

### ストーリー2: 作業時間記録
- **である** 創作活動を行う人 **として**
- **私は** 実際の作業時間を正確に記録 **をしたい**
- **そうすることで** 見積もりの精度を上げ、適切な休憩を取れる

**実装根拠**: 
- タイマー機能（`use-timer.ts`、`timer-controls.tsx`）
- 作業セッション記録（`WorkSession`エンティティ）
- ポモドーロテクニック対応

### ストーリー3: セルフケア記録
- **である** 長時間作業する創作者 **として**
- **私は** 気分や達成感を記録 **をしたい**
- **そうすることで** 心身の状態を把握し、持続可能な創作活動ができる

**実装根拠**: 
- 気分記録機能（`mood-dialog.tsx`、9段階評価）
- ドーパミン記録機能（`dopamine-dialog.tsx`）
- 日次コンディション記録

### ストーリー4: スケジュール管理
- **である** 締切のある創作者 **として**
- **私は** 週単位でタスクをスケジューリング **をしたい**
- **そうすることで** 無理のない作業計画を立て、締切を守れる

**実装根拠**: 
- 週次カレンダー（`weekly-calendar.tsx`）
- ドラッグ&ドロップ機能
- 睡眠スケジュール管理

### ストーリー5: オフライン作業
- **である** 様々な環境で作業する創作者 **として**
- **私は** インターネット接続なしでも作業を記録 **をしたい**
- **そうすることで** 場所を選ばず創作活動に集中できる

**実装根拠**: 
- オフライン検知（`offline-detector.ts`）
- IndexedDB（ローカルストレージ）
- 自動同期機能（`sync-service.ts`）

## 機能要件（EARS記法）

### 通常要件

#### REQ-001: プロジェクト管理
システムは創作者がプロジェクトを作成、編集、削除、一覧表示できる機能を提供しなければならない。

**実装根拠**: 
- `projectRepository` のCRUD操作
- `ProjectList`、`ProjectForm` コンポーネント

#### REQ-002: WBSタスク管理
システムは大タスクと小タスクの2階層でタスクを管理する機能を提供しなければならない。

**実装根拠**:
- `BigTask`、`SmallTask` エンティティ
- タスク間の親子関係（`big_task_id`）

#### REQ-003: タイマー機能
システムは作業時間を計測し、セッションとして記録する機能を提供しなければならない。

**実装根拠**:
- `TimerControls` コンポーネント
- `WorkSession` エンティティ
- `useTimer` フック

#### REQ-004: 週次スケジュール
システムはドラッグ&ドロップで小タスクを時間枠に配置できるカレンダーを提供しなければならない。

**実装根拠**:
- `WeeklyCalendar` コンポーネント
- `@dnd-kit` ライブラリの使用

#### REQ-005: 気分記録
システムは9段階の気分レベルとメモを記録する機能を提供しなければならない。

**実装根拠**:
- `MoodDialog` コンポーネント
- `MoodEntry` エンティティ
- 9つの気分アイコン定義

#### REQ-006: ドーパミン記録
システムは達成感や喜びのイベントを記録する機能を提供しなければならない。

**実装根拠**:
- `DopamineDialog` コンポーネント
- `DopamineEntry` エンティティ

### 条件付き要件

#### REQ-101: オフライン時のデータ保存
ネットワーク接続がない場合、システムはデータをローカルストレージに保存しなければならない。

**実装根拠**:
- `OfflineDetector` クラス
- IndexedDB（Dexie）実装

#### REQ-102: オンライン復帰時の自動同期
ネットワーク接続が復帰した場合、システムは未同期データを自動的にサーバーと同期しなければならない。

**実装根拠**:
- `SyncService.startAutoSync()`
- 同期キュー管理

#### REQ-103: タイマー実行中のタスク切り替え
タイマーが実行中の場合、システムは確認ダイアログを表示してから新しいタスクに切り替えなければならない。

**実装根拠**:
- タスク切り替え時の確認処理
- 現在のセッション終了処理

#### REQ-104: 競合解決
同一データが複数箇所で更新された場合、システムは最終更新時刻に基づいて競合を解決しなければならない。

**実装根拠**:
- `ConflictResolver` クラス
- Last-Write-Wins戦略

### 状態要件

#### REQ-201: タイマー実行状態の表示
タイマーが実行中の場合、システムは経過時間と現在のタスクを表示しなければならない。

**実装根拠**:
- `TimerStore` の状態管理
- リアルタイム更新表示

#### REQ-202: オフライン状態の表示
オフライン状態の場合、システムはオフラインインジケーターを表示しなければならない。

**実装根拠**:
- `SyncStatusIndicator` コンポーネント
- `useSyncStore` の状態

#### REQ-203: 同期待ち状態の表示
未同期データが存在する場合、システムは同期待ちバッジを表示しなければならない。

**実装根拠**:
- 同期キューカウント表示
- ペンディング操作数の表示

### オプション要件

#### REQ-301: プロジェクトカラー設定
システムはプロジェクトに識別用のカラーを設定できるようにしてもよい。

**実装根拠**:
- `ProjectColorPicker` コンポーネント
- HSL形式のカラー保存

#### REQ-302: タスクタグ付け
システムは小タスクにタグを付けられるようにしてもよい。

**実装根拠**:
- `SmallTask.tags` フィールド
- タグ配列の管理

#### REQ-303: 睡眠スケジュール設定
システムは週単位で睡眠時間を設定できるようにしてもよい。

**実装根拠**:
- `WeeklySleepScheduleDialog` コンポーネント
- `SleepSchedule` エンティティ

### 制約要件

#### REQ-401: プロジェクト名制約
システムはプロジェクト名を1文字以上100文字以内に制限しなければならない。

**実装根拠**:
- Zodスキーマ: `z.string().min(1).max(100)`

#### REQ-402: タスク見積時間制約
システムは小タスクの見積時間を5分以上600分以内に制限しなければならない。

**実装根拠**:
- バリデーション: `.min(5).max(600)`

#### REQ-403: 説明文字数制約
システムはタスクの説明を500文字以内に制限しなければならない。

**実装根拠**:
- Zodスキーマ: `z.string().max(500)`

#### REQ-404: API認証要求
システムは同期APIへのアクセスにAPIキー認証を要求しなければならない。

**実装根拠**:
- `validateApiKey()` 関数
- X-API-Keyヘッダー検証

## 非機能要件

### パフォーマンス

#### NFR-001: ローカル操作の即時性
システムはローカルデータ操作を100ミリ秒以内に完了しなければならない。

**実装根拠**:
- IndexedDBの高速アクセス
- 楽観的更新の実装

#### NFR-002: 同期リトライ戦略
システムは同期失敗時に指数バックオフでリトライしなければならない（最大10分間隔）。

**実装根拠**:
- `RetryStrategy` クラス
- `Math.min(baseDelay * Math.pow(1.5, attemptCount), 600000)`

### セキュリティ

#### NFR-101: APIキー保護
システムはAPIキーを環境変数で管理し、クライアントに露出してはならない。

**実装根拠**:
- `process.env.SYNC_API_KEY`
- サーバーサイドでの検証

#### NFR-102: データ整合性
システムはバージョン管理により、データの整合性を保証しなければならない。

**実装根拠**:
- `version` フィールド
- 楽観的ロック実装

### ユーザビリティ

#### NFR-201: レスポンシブデザイン
システムはモバイルデバイスでも操作可能でなければならない。

**実装根拠**:
- Tailwind CSSのレスポンシブクラス
- `use-mobile` フックの実装

#### NFR-202: キーボードショートカット
システムは主要操作にキーボードショートカットを提供しなければならない。

**推定根拠**:
- E2Eテストでのキーボード操作テスト

#### NFR-203: 直感的なUI
システムはドラッグ&ドロップなど直感的な操作を提供しなければならない。

**実装根拠**:
- `@dnd-kit` ライブラリ
- 視覚的フィードバック

### 信頼性

#### NFR-301: オフライン耐性
システムはネットワーク断絶時も継続して動作しなければならない。

**実装根拠**:
- オフラインファースト設計
- ローカルストレージ優先

#### NFR-302: データ永続性
システムはブラウザを閉じてもデータを保持しなければならない。

**実装根拠**:
- IndexedDBによる永続化
- 自動保存機能

#### NFR-303: エラーリカバリー
システムはデータベースエラーから自動回復を試みなければならない。

**実装根拠**:
- `db.handleSchemaError()`
- エラー時の再試行処理

### 運用性

#### NFR-401: ログ管理
システムは環境に応じたログレベルで動作ログを出力しなければならない。

**実装根拠**:
- `Logger` クラス
- 開発/本番環境の切り替え

#### NFR-402: デバッグ支援
システムは開発者向けのデバッグ機能を提供しなければならない。

**実装根拠**:
- `/debug` ページ
- テストデータ生成機能

## Edgeケース

### エラー処理

#### EDGE-001: ネットワーク断続
ネットワークが断続的に切断・接続を繰り返す場合の処理

**実装根拠**:
- 定期的な接続チェック（30秒間隔）
- ページ表示/非表示イベント監視

#### EDGE-002: ストレージ容量不足
IndexedDBの容量制限に達した場合の処理

**推定根拠**:
- エラーハンドリング実装
- ユーザーへの通知機能

#### EDGE-003: 同時編集競合
同一データを複数デバイスで同時編集した場合

**実装根拠**:
- Last-Write-Wins戦略
- タイムスタンプベースの解決

### 境界値

#### EDGE-101: 最大タスク数
大量のタスクが存在する場合のパフォーマンス

**推定根拠**:
- パフォーマンステストでの1000件処理

#### EDGE-102: 長時間タイマー
24時間以上のタイマー実行

**実装根拠**:
- セッション復元機能
- 経過時間の正確な計算

#### EDGE-103: 古いデータの同期
長期間オフラインだったデータの同期

**実装根拠**:
- タイムスタンプベースの同期
- 全データ取得API

## 受け入れ基準

### 実装済み機能テスト

- [x] プロジェクト管理機能
  - [x] プロジェクトの作成・編集・削除
  - [x] プロジェクト一覧表示
  - [x] カラー設定
- [x] タスク管理機能
  - [x] 大タスク・小タスクの階層管理
  - [x] タスクステータス管理
  - [x] 見積・実績時間記録
- [x] タイマー機能
  - [x] タイマー開始・停止
  - [x] 作業セッション記録
  - [x] タスクとの紐付け
- [x] オフライン対応
  - [x] オフライン検知
  - [x] ローカルデータ保存
  - [x] 自動同期

### 推奨追加テスト

- [ ] **E2Eテストスイート**
  - [ ] 完全なユーザーフロー
  - [ ] オフライン→オンライン遷移
  - [ ] 複数デバイス同期
- [ ] **パフォーマンステスト**
  - [ ] 大量データ処理
  - [ ] 同時アクセス負荷
  - [ ] メモリ使用量監視
- [ ] **セキュリティテスト**
  - [ ] XSS対策
  - [ ] APIキー漏洩防止
  - [ ] データアクセス制御

## 推定されていない要件

### 不明確な部分

以下の要件は実装から推定が困難なため、ステークホルダーとの確認が必要：

1. **ビジネス要件**
   - 具体的なターゲットユーザー層
   - 収益モデル（無料/有料）
   - 将来的な機能拡張計画

2. **運用要件**
   - データバックアップ頻度
   - サポート体制
   - SLA（サービスレベル合意）

3. **法的要件**
   - 個人情報保護方針
   - 利用規約
   - データ保存期間

### 推奨される次ステップ

1. **ユーザビリティテスト** - 実際の創作者による使用感確認
2. **パフォーマンス最適化** - 大規模データでの動作検証
3. **セキュリティ監査** - 外部専門家によるレビュー
4. **多言語対応** - 国際展開の検討

## 分析の制約事項

### 信頼度に影響する要因

- **テストカバレッジ**: 約20% - 多くの機能が未テスト
- **ドキュメント不足**: コード内コメントが少ない
- **推定による補完**: ビジネス意図は推定

### 推定の根拠

- **強い根拠**: 実装 + テスト + 明確な動作（85%）
- **中程度の根拠**: 実装 + 部分的テスト（70%）
- **弱い根拠**: 実装のみ、推定で補完（50%）